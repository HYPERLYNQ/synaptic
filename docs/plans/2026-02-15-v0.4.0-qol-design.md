# Synaptic v0.4.0 — Quality of Life (Fast Search + Enforced Rules)

## Problem Statement

Two user pain points:

1. **Search is slow (3-5s per query)** — Transformers.js embedding inference on CPU is the bottleneck. Only ~30 entries in the DB, so it is not a data volume problem. The embedder loads lazily on first use, and even cached, each `embed()` call takes ~200-500ms in JS.
2. **No way to enforce persistent rules** — When the user says "don't do X", there is no mechanism to store that as a hard constraint that gets injected every session. The user has to keep repeating themselves.

Secondary concern:

3. **Token-heavy session-start injection** — Current injection dumps ~500 lines including near-duplicate handoff notes and zero-change maintenance summaries. Wasteful.

## Design

### Part 1: Fast Search

#### 1.1 Pre-warm Embedder on Startup

- In `index.ts`, after server init, call `embedder.embed("warmup")`
- This loads the `Xenova/all-MiniLM-L6-v2` model into memory before any tool call
- Eliminates 2-3s cold start on first search
- Do this in background — do not block server startup or tool registration

#### 1.2 Query Embedding Cache

- Add LRU cache in `embedder.ts` (in-memory `Map`, ~100 entries max)
- Key: normalized/trimmed query string. Value: `Float32Array` (384-dim)
- On `embed()`, check cache first. Hit = instant return. Miss = compute + store.
- Eviction: when cache exceeds 100 entries, drop oldest by insertion order
- No persistence needed — cache lives for server process lifetime only

#### 1.3 BM25 Fast Path

- In `context-search.ts`, add optional `mode` parameter: `"fast"` | `"semantic"` | `"hybrid"` (default: `"hybrid"`)
- `"fast"` = BM25 only, skips vector search entirely, <50ms
- `"semantic"` = vector only
- `"hybrid"` = current RRF behavior (BM25 + vector + Reciprocal Rank Fusion)
- Auto-detect: if query is <=3 words with no question marks, default to `"fast"` instead of `"hybrid"`
- This lets simple lookups like `"synaptic"` or `"field-bridge auth"` skip embedding entirely

#### 1.4 Batch Access Tracking

- In `sqlite.ts`, replace N individual `UPDATE entries SET access_count = access_count + 1 WHERE id = ?` calls with one batched statement:
  ```sql
  UPDATE entries SET access_count = access_count + 1, last_accessed = ? WHERE id IN (...)
  ```
- Single statement, single DB write

---

### Part 2: Enforced Rules

#### 2.1 New `rule` Entry Type

- Add `"rule"` to the entry type enum across all tools and storage
- Rules are always `tier="longterm"`, always `pinned=1`
- Rules have a unique `label` field (short key like `"commit-messages"`, `"no-semicolons"`)
- Label stored in a dedicated `label` column (not tags) for clean querying

#### 2.2 Schema Change

- Add `label TEXT` column to `entries` table (nullable, only used by rules)
- Add partial unique index:
  ```sql
  CREATE UNIQUE INDEX idx_entries_rule_label ON entries(label) WHERE type = 'rule'
  ```
- This enforces one rule per label at the DB level
- Existing entries unaffected (label is nullable)

#### 2.3 New Tool: `context_save_rule`

- Params: `content` (string, the rule text), `label` (string, unique key)
- Behavior: UPSERT — if a rule with that label exists, overwrite content + update timestamp. If not, create new.
- Auto-sets: `type="rule"`, `tier="longterm"`, `pinned=1`
- No embedding needed for rules (they are injected directly, not searched semantically)
- Returns confirmation with the label

#### 2.4 New Tool: `context_delete_rule`

- Params: `label` (string)
- Deletes the rule with that label (hard delete, not archive)
- Returns confirmation or "rule not found"

#### 2.5 New Tool: `context_list_rules`

- No params required
- Returns all active rules with their labels and content
- Simple, direct — no search needed

#### 2.6 Session-Start Injection — Rules First

- Rules injected as the FIRST section, before everything else
- Format (compact, directive):
  ```
  # Rules (ALWAYS follow, NO exceptions)
  - Never include emoji in commit messages
  - Do not add comments unless asked
  - Never commit without asking
  ```
- Labels are internal only (not shown in injection — saves tokens)
- If no rules exist, skip the section entirely (no empty header)

---

### Part 3: Token-Conscious Injection

#### 3.1 Token Budget

- Add configurable max injection size (default: ~800 tokens, roughly 3200 chars)
- Priority order: rules (always full) > recent context > handoff notes > maintenance
- If budget exceeded, truncate from the bottom (maintenance first, then handoffs, then context)
- Rules are never truncated

#### 3.2 Deduplicate Handoff Notes

- Currently shows up to 3 handoffs from last 7 days — most are auto-generated and nearly identical
- Change: show only the single most recent handoff note
- If it is essentially identical to recent context entries, skip it entirely

#### 3.3 Trim Maintenance Noise

- Only include maintenance summary if something actually happened (`decay > 0` OR `demotion > 0` OR `promotion > 0`)
- "Maintenance: nothing to report" wastes tokens — just omit

#### 3.4 Compact Output Format

- Current: `- **21:07** (issue) [field-bridge, auth]: Fixed authentication JWT token refresh bug`
- New: `- 02-15 21:07 [issue] Fixed authentication JWT token refresh bug`
- Drop bold markers, drop tags from display (they are searchable, not display-worthy)
- Drop full year from dates (unnecessary within a 3-day window)

---

## Files Changed

| File | Change |
|---|---|
| `src/index.ts` | Pre-warm embedder on startup |
| `src/storage/embedder.ts` | Add LRU query cache |
| `src/storage/sqlite.ts` | Add label column, rule UPSERT, batch access update, schema migration |
| `src/tools/context-search.ts` | Add `mode` param (`fast`/`semantic`/`hybrid`), auto-detect |
| `src/tools/context-save-rule.ts` | New tool — save/update rules by label |
| `src/tools/context-delete-rule.ts` | New tool — delete rules by label |
| `src/tools/context-list-rules.ts` | New tool — list all active rules |
| `src/server.ts` | Register new tools |
| `src/hooks/session-start.ts` | Rules-first injection, token budget, dedup handoffs, compact format, trim maintenance |
| `package.json` | Bump to 0.4.0 |

## Migration

- Schema migration:
  ```sql
  ALTER TABLE entries ADD COLUMN label TEXT;
  CREATE UNIQUE INDEX idx_entries_rule_label ON entries(label) WHERE type = 'rule';
  ```
- Existing entries unaffected (label is nullable)

## Version

0.4.0
